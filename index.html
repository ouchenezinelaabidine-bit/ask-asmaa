<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>اسأل الأستاذة أسماء</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- MathJax -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<style>
:root{
  --bg0:#050c18;
  --bg1:#071426;
  --panel:#0b1f3a;
  --line:rgba(255,255,255,.09);
  --text:#eaf2ff;
  --muted:#a2b4d8;
  --accent:#4da3ff;
  --accent2:#76c3ff;

  --meGrad: linear-gradient(135deg, #1e90ff, #4da3ff);
  --botBg: rgba(18,43,82,.92);

  --shadow: 0 28px 90px rgba(0,0,0,.55);
  --shadow2: 0 12px 35px rgba(0,0,0,.35);
  --r:18px;

  --waA: rgba(77,163,255,.08);
  --waB: rgba(118,195,255,.06);
}
*{box-sizing:border-box}
html,body{height:100%}

/* ✅ FIX: no vertical centering (avoids “limited/cropped” start on iOS) */
body{
  margin:0;
  font-family:"Cairo", system-ui, Segoe UI, Arial;
  background:
    radial-gradient(1200px 650px at 15% 10%, rgba(77,163,255,.18), transparent 55%),
    radial-gradient(900px 600px at 85% 15%, rgba(118,195,255,.12), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  color:var(--text);
  display:block;
  padding:14px;
  min-height:100vh;
  min-height:100dvh;
}

/* ✅ FIX: stable full height + centered horizontally */
.app{
  width:min(1200px,100%);
  margin:0 auto;
  min-height:calc(100vh - 28px);
  min-height:calc(100dvh - 28px);
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:14px;
}
@media (max-width: 980px){
  .app{ grid-template-columns: 1fr; }
}

/* side */
.side{
  height:100%;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius: calc(var(--r) + 6px);
  box-shadow: var(--shadow2);
  overflow:hidden;
}
.sideHeader{
  padding:16px 16px 12px;
  border-bottom:1px solid var(--line);
  background:
    radial-gradient(800px 260px at 15% 0%, rgba(77,163,255,.22), transparent 60%),
    radial-gradient(700px 260px at 90% 0%, rgba(118,195,255,.16), transparent 65%);
}
.brandRow{display:flex;gap:12px;align-items:center}
.badgeOrb{
  width:44px;height:44px;border-radius:14px;
  background: conic-gradient(from 180deg, #1e90ff, #76c3ff, #1e90ff);
  box-shadow: 0 0 0 6px rgba(77,163,255,.10), 0 18px 40px rgba(0,0,0,.45);
}
.sideTitle{margin:0;font-size:18px;font-weight:800}
.sideSub{margin:2px 0 0;font-size:13px;color:rgba(234,242,255,.75);line-height:1.6}
.sideBody{padding:14px 16px 16px}

.card{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  border-radius: var(--r);
  padding:14px;
  margin-top:12px;
}
.card h3{margin:0 0 8px;font-size:14px;color:#dbe7ff}
.card p{margin:0;color:rgba(234,242,255,.78);font-size:13px;line-height:1.75}

.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.pill{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:#eaf2ff;
  padding:8px 10px;
  border-radius:999px;
  font-size:12.5px;
  cursor:pointer;
  user-select:none;
  transition: transform .08s ease, background .15s ease;
}
.pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }

.langRow{display:flex;gap:8px;margin-top:10px}
.langBtn{
  flex:1;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:#eaf2ff;
  padding:10px 10px;
  border-radius: 999px;
  font-weight:800;
  cursor:pointer;
}
.langBtn.active{
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color:#041225;
  border-color: rgba(77,163,255,.35);
}

/* selectors */
.selectGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
  margin-top:10px;
}
.selLabel{
  font-size:12.5px;
  color:rgba(234,242,255,.78);
  margin-bottom:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.selectWrap{
  border:1px solid var(--line);
  background: rgba(0,0,0,.20);
  border-radius: 14px;
  padding:10px 10px;
}
select{
  width:100%;
  border:none;
  outline:none;
  background:transparent;
  color:var(--text);
  font-family:"Cairo", system-ui, Segoe UI, Arial;
  font-weight:800;
  font-size:13.5px;
}
option{ color:#071426; }

.smallHint{
  font-size:12px;
  color:rgba(234,242,255,.60);
  line-height:1.6;
  margin-top:8px;
}

/* chat panel */
.chatPanel{
  height:100%;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius: calc(var(--r) + 6px);
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  position:relative;
}
.chatHeader{
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  background: linear-gradient(90deg, rgba(77,163,255,.16), rgba(118,195,255,.08));
}
.chatHeaderLeft{display:flex;align-items:center;gap:10px;min-width:0}
.logo{
  width:40px;height:40px;border-radius:14px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  display:grid;place-items:center;
  font-weight:900;
}
.hTitle{margin:0;font-weight:900;font-size:16px}
.hSub{margin:0;color:rgba(234,242,255,.72);font-size:12.5px}

/* chat */
.chat{
  flex:1;
  padding:16px 14px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:12px;
  scroll-behavior:auto; /* ✅ iOS friendly */
  -webkit-overflow-scrolling: touch;

  background:
    radial-gradient(220px 160px at 15% 20%, var(--waA), transparent 60%),
    radial-gradient(240px 180px at 80% 35%, var(--waB), transparent 60%),
    radial-gradient(220px 160px at 30% 85%, var(--waB), transparent 60%),
    linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.14));
}

/* messages layout: bot left, me right */
.row{ display:flex; gap:10px; align-items:flex-end; }
.row.me{ justify-content:flex-end; }
.row.bot{ justify-content:flex-start; }

.avatar{
  width:32px;height:32px;border-radius:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  display:grid;place-items:center;
  font-weight:900;
  flex:0 0 auto;
}
.avatar.me{ background: rgba(77,163,255,.12); }
.avatar.bot{ background: rgba(255,255,255,.06); }

.bubbleWrap{max-width: 86%; display:flex; flex-direction:column; gap:6px; position:relative;}
.bubble{
  padding:12px 12px;
  border-radius:18px;
  border:1px solid var(--line);
  line-height:1.85;
  font-size:14.5px;
  white-space:pre-wrap;
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
}

.bubble::after{
  content:"";
  position:absolute;
  bottom:10px;
  width:14px;height:14px;
  transform: rotate(45deg);
  border-radius:3px;
  opacity:.95;
}
.row.me .bubble::after{ right:-6px; background: #2b9bff; border-right:1px solid rgba(77,163,255,.18); border-bottom:1px solid rgba(77,163,255,.18); }
.row.bot .bubble::after{ left:-6px; background: rgba(18,43,82,.92); border-left:1px solid rgba(255,255,255,.07); border-bottom:1px solid rgba(255,255,255,.07); }

.row.me .bubble{ background: var(--meGrad); color:#041225; border-color: rgba(77,163,255,.35); }
.row.bot .bubble{ background: var(--botBg); }

.meta{
  font-size:12px;
  color:rgba(234,242,255,.55);
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.meta .leftMeta{display:flex;gap:8px;align-items:center}
.meta .rightMeta{display:flex;gap:8px;align-items:center}
.miniBtn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding:5px 8px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
  font-weight:800;
}
.miniBtn:hover{ background: rgba(255,255,255,.10); }

.typingBubble{
  max-width: 70%;
  padding:12px 12px;
  border-radius:18px;
  border:1px dashed rgba(77,163,255,.35);
  background: rgba(18,43,82,.55);
  color: rgba(234,242,255,.85);
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
}
.typingLine{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  font-weight:800;
}
.dots{display:inline-flex;gap:5px;align-items:center}
.dots span{
  width:7px;height:7px;border-radius:50%;
  background: var(--accent);
  animation: blink 1.1s infinite ease-in-out;
}
.dots span:nth-child(2){animation-delay:.15s}
.dots span:nth-child(3){animation-delay:.30s}
@keyframes blink{
  0%,100%{opacity:.25; transform: translateY(0);}
  50%{opacity:1; transform: translateY(-2px);}
}

/* composer */
.composer{
  padding:12px 12px 14px;
  border-top:1px solid var(--line);
  background: rgba(0,0,0,.12);
}
.composerRow{display:flex;gap:10px;align-items:flex-end}
.inputWrap{
  flex:1;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  border-radius: 18px;
  padding:10px 12px;
}
textarea{
  width:100%;
  border:none;
  outline:none;
  resize:none;
  background:transparent;
  color:var(--text);
  font-size:15px;
  line-height:1.7;
  min-height:44px;
  max-height:140px;
  font-family: "Cairo", system-ui, Segoe UI, Arial;
}
textarea::placeholder{ color: rgba(234,242,255,.55); }

.actionsCol{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width: 170px;
}
@media(max-width: 520px){
  .actionsCol{ min-width: 140px; }
}
.btn{
  border:none;
  cursor:pointer;
  border-radius: 14px;
  padding:11px 12px;
  font-weight:900;
  color:#041225;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 16px 35px rgba(77,163,255,.18);
}
.btn:disabled{ opacity:.55; cursor:not-allowed; }
.btn.secondary{
  background: rgba(255,255,255,.06);
  color: var(--text);
  border:1px solid var(--line);
  box-shadow:none;
}

.preview{
  margin-top:8px;
  font-size:12.5px;
  color: rgba(234,242,255,.60);
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.kbdHint{
  margin-top:8px;
  font-size:12px;
  color: rgba(234,242,255,.55);
}
.kbd{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.20);
  padding:2px 6px;
  border-radius:8px;
  color: rgba(234,242,255,.85);
  font-size:11px;
  margin-inline:3px;
}

/* Scroll-to-top */
.toTop{
  position:absolute;
  left:14px;
  bottom:92px;
  width:46px;
  height:46px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.35);
  color: var(--text);
  display:grid;
  place-items:center;
  cursor:pointer;
  box-shadow: 0 16px 35px rgba(0,0,0,.35);
  opacity:0;
  pointer-events:none;
  transform: translateY(8px);
  transition: opacity .2s ease, transform .2s ease, background .15s ease;
  z-index:5;
}
.toTop:hover{ background: rgba(255,255,255,.06); }
.toTop.show{ opacity:1; pointer-events:auto; transform: translateY(0); }
.toTop span{ font-size:18px; font-weight:900; line-height:1; }

.toast{
  position:absolute;
  top:14px;
  right:14px;
  background: rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.10);
  color: rgba(234,242,255,.92);
  padding:10px 12px;
  border-radius: 14px;
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  opacity:0;
  transform: translateY(-6px);
  transition: opacity .18s ease, transform .18s ease;
  z-index:10;
  font-size:13px;
  font-weight:800;
}
.toast.show{ opacity:1; transform: translateY(0); }

/* rtl / ltr */
body.ltr{ direction:ltr; }
body.ltr .toTop{ left:auto; right:14px; }
body.ltr .toast{ right:auto; left:14px; }
</style>
</head>

<body>

<div class="app">

  <aside class="side">
    <div class="sideHeader">
      <div class="brandRow">
        <div class="badgeOrb" aria-hidden="true"></div>
        <div style="min-width:0">
          <h2 class="sideTitle" id="sideTitle">الأستاذة أسماء</h2>
          <p class="sideSub" id="sideSub">منصة رياضيات مميزة • شرح خطوة بخطوة</p>
        </div>
      </div>
    </div>

    <div class="sideBody">
      <div class="card">
        <h3 id="howTitle">طريقة التواصل</h3>
        <p id="howText">
          • اكتب السؤال بوضوح داخل الدردشة.<br>
          • أرسل تمرينًا واحدًا في كل مرة للحصول على شرح دقيق.
        </p>
        <div class="pills" id="pills">
          <span class="pill" data-ex="حل المعادلة: 2x + 3 = 11">حل معادلة</span>
          <span class="pill" data-ex="حل المعادلة التفاضلية: y' = y">تفاضلية</span>
          <span class="pill" data-ex="اشتق الدالة: f(x)=x^3 - 5x + 2">اشتقاق</span>
          <span class="pill" data-ex="بسّط: (x^2-1)/(x-1)">تبسيط</span>
        </div>
      </div>

      <div class="card">
        <h3 id="langTitle">اختيار اللغة</h3>
        <div class="langRow">
          <button class="langBtn active" id="btnAr" type="button">العربية</button>
          <button class="langBtn" id="btnEn" type="button">English</button>
        </div>
      </div>

      <div class="card">
        <h3 id="levelTitle">المستوى</h3>
        <div class="selectGrid">
          <div>
            <div class="selLabel"><span id="lvlLabel">اختر مستوى الطالب</span><span id="lvlChip" style="color:rgba(234,242,255,.65);font-size:12px;font-weight:900;"></span></div>
            <div class="selectWrap">
              <select id="level">
                <option value="primary">ابتدائي</option>
                <option value="middle">متوسط</option>
                <option value="high">ثانوي</option>
                <option value="uni">جامعي</option>
              </select>
            </div>
          </div>

          <div>
            <div class="selLabel"><span id="modeLabel">أسلوب الإجابة</span><span id="modeChip" style="color:rgba(234,242,255,.65);font-size:12px;font-weight:900;"></span></div>
            <div class="selectWrap">
              <select id="mode">
                <option value="simple">شرح مبسط</option>
                <option value="steps">حل خطوة بخطوة</option>
                <option value="final">الجواب فقط</option>
                <option value="quiz">اختبرني ثم صحح</option>
              </select>
            </div>
          </div>
        </div>
        <div class="smallHint" id="levelHint">اختر المستوى وأسلوب الإجابة قبل الإرسال لتحصل على شرح مناسب.</div>
      </div>

      <div class="card">
        <h3 id="noteTitle">ملاحظة</h3>
        <p id="noteText">اكتب التمرين كاملا وانتظر بضع ثواني وسيكون الحل بين يديك .</p>
      </div>
    </div>
  </aside>

  <main class="chatPanel">
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <div class="logo">∑</div>
        <div style="min-width:0">
          <!-- ✅ FIX: show teacher name on top -->
          <p class="hTitle" id="mainTitle">الأستاذة أسماء</p>
          <p class="hSub" id="mainSub">جلسة الرياضيات • اكتب سؤالك وسأشرحه حسب المستوى</p>
        </div>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div id="toast" class="toast"></div>

    <button id="toTop" class="toTop" type="button" aria-label="الرجوع للأعلى">
      <span>↑</span>
    </button>

    <div class="composer">
      <div class="composerRow">
        <div class="inputWrap">
          <textarea id="input" placeholder="اكتب سؤالك في الرياضيات هنا..."></textarea>
        </div>

        <div class="actionsCol">
          <button class="btn" id="sendBtn" type="button">إرسال</button>
          <button class="btn secondary" id="clearBtn" type="button">مسح المحادثة</button>
        </div>
      </div>

      <div class="preview">
        <span id="statusText"></span>
        <span id="pillStatus" style="font-weight:900;"></span>
      </div>

      <div class="kbdHint" id="kbdHint">
        للإرسال: <span class="kbd">Enter</span> — سطر جديد: <span class="kbd">Shift</span> + <span class="kbd">Enter</span>
      </div>
    </div>
  </main>

</div>

<script>
const WORKER_URL = "https://ask-asmaa.ouchene-zinelaabidine.workers.dev";

const STORAGE_KEY = "asmaa_chat_v2";
const PREF_KEY = "asmaa_prefs_v2";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const statusText = document.getElementById("statusText");
const pillStatus = document.getElementById("pillStatus");

const btnAr = document.getElementById("btnAr");
const btnEn = document.getElementById("btnEn");
const toTopBtn = document.getElementById("toTop");
const toast = document.getElementById("toast");

const levelSel = document.getElementById("level");
const modeSel = document.getElementById("mode");
const lvlChip = document.getElementById("lvlChip");
const modeChip = document.getElementById("modeChip");

const mainTitle = document.getElementById("mainTitle");
const mainSub   = document.getElementById("mainSub");

const I18N = {
  ar: {
    sideTitle: "الأستاذة أسماء",
    sideSub: "منصة رياضيات مميزة • ذكاء متخصص في الرياضيات",
    howTitle: "طريقة التواصل",
    howText:
`• اكتب السؤال بوضوح داخل الدردشة.
• أرسل تمرينًا واحدًا في كل مرة للحصول على شرح دقيق.`,
    langTitle: "اختيار اللغة",
    levelTitle:"المستوى",
    lvlLabel:"اختر مستوى الطالب",
    modeLabel:"أسلوب الإجابة",
    levelHint:"اختر المستوى وأسلوب الإجابة قبل الإرسال لتحصل على شرح مناسب.",
    mainTitle: "الأستاذة أسماء",
    mainSub: "جلسة الرياضيات • اكتب سؤالك وسأشرحه حسب المستوى",
    clear: "مسح المحادثة",
    send: "إرسال",
    placeholder: "اكتب سؤالك في الرياضيات هنا...",
    greeting: "أهلًا بك! اختر المستوى ثم اكتب سؤالك في الرياضيات وسأشرحه بالطريقة المناسبة.",
    cleared: "تم مسح المحادثة. ابدأ تمرينًا جديدًا.",
    preparing: "الأستاذة أسماء تُحضّر الإجابة",
    busy: "جاري الإرسال...",
    onlyMath: "هذه المنصة مخصصة للرياضيات فقط. اكتب سؤالًا رياضيًا من فضلك.",
    copied: "تم النسخ ✅",
    restored: "تم استرجاع المحادثة ✅"
  },
  en: {
    sideTitle: "Ms. Asmaa",
    sideSub: "Math-only AI • Step-by-step explanations",
    howTitle: "How to ask",
    howText:
`• Write your question clearly.
• Send one exercise at a time for best accuracy.`,
    langTitle: "Language",
    levelTitle:"Level",
    lvlLabel:"Choose student level",
    modeLabel:"Answer style",
    levelHint:"Pick level & style before sending for a better explanation.",
    mainTitle: "Ms. Asmaa",
    mainSub: "Math session • Ask and get a level-based explanation",
    clear: "Clear chat",
    send: "Send",
    placeholder: "Type your math question here...",
    greeting: "Welcome! Choose a level, then type your math question and I’ll explain it accordingly.",
    cleared: "Chat cleared. Start a new exercise.",
    preparing: "Ms. Asmaa is preparing the answer",
    busy: "Sending...",
    onlyMath: "This assistant is for math only. Please ask a math question.",
    copied: "Copied ✅",
    restored: "Chat restored ✅"
  }
};

let lang = "ar";

const LEVEL_LABELS = {
  primary: { ar:"ابتدائي", en:"Primary" },
  middle:  { ar:"متوسط",  en:"Middle"  },
  high:    { ar:"ثانوي",  en:"High school" },
  uni:     { ar:"جامعي",  en:"University" }
};
const MODE_LABELS = {
  simple: { ar:"شرح مبسط", en:"Simple explanation" },
  steps:  { ar:"خطوة بخطوة", en:"Step-by-step" },
  final:  { ar:"الجواب فقط", en:"Final answer only" },
  quiz:   { ar:"اختبرني ثم صحح", en:"Quiz me & correct" }
};

function nowTime(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1200);
}

function looksMathy(text){
  const t = (text||"").toLowerCase();
  const hasMathSymbols = /[0-9x y z+\-*/^=()√π∞∫∑]/.test(text);
  const hasMathWordsAr = /(حل|معادلة|اشتق|تكامل|تفاضل|دالة|متباينة|مشتقة|نهاية|متتالية|متسلسلة|احتمال|هندسة|زوايا|مثلث|مربع|دائرة|جبر|حساب)/.test(text);
  const hasMathWordsEn = /(solve|equation|derivative|integral|limit|function|probability|geometry|algebra|matrix|vectors|trigonometry)/.test(t);
  return hasMathSymbols || hasMathWordsAr || hasMathWordsEn;
}

/* ✅ iOS-safe scrolling */
function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }
function scrollToTopHard(){
  chat.scrollTop = 0;
  requestAnimationFrame(()=>{ chat.scrollTop = 0; });
  window.scrollTo({ top:0, left:0, behavior:"auto" });
}

function addMsg(role, text, opts={}){
  const row = document.createElement("div");
  row.className = "row " + (role === "me" ? "me" : "bot");

  const avatar = document.createElement("div");
  avatar.className = "avatar " + (role === "me" ? "me":"bot");
  avatar.textContent = role === "me" ? (lang==="ar" ? "أ" : "Me") : "∑";

  const wrap = document.createElement("div");
  wrap.className = "bubbleWrap";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta";

  const leftMeta = document.createElement("div");
  leftMeta.className = "leftMeta";
  leftMeta.innerHTML = `<span>${role === "me" ? (lang==="ar"?"أنت":"You") : (lang==="ar"?"الأستاذة أسماء":"Ms. Asmaa")}</span> • <span>${nowTime()}</span>`;

  const rightMeta = document.createElement("div");
  rightMeta.className = "rightMeta";

  if(role === "bot"){
    const copyBtn = document.createElement("button");
    copyBtn.type = "button";
    copyBtn.className = "miniBtn";
    copyBtn.textContent = (lang==="ar" ? "نسخ" : "Copy");
    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(text);
        showToast(I18N[lang].copied);
      }catch{
        showToast(lang==="ar" ? "لم يتم النسخ" : "Copy failed");
      }
    });
    rightMeta.appendChild(copyBtn);
  }

  meta.appendChild(leftMeta);
  meta.appendChild(rightMeta);

  wrap.appendChild(bubble);
  wrap.appendChild(meta);

  if(role === "me"){
    row.appendChild(wrap);
    row.appendChild(avatar);
  }else{
    row.appendChild(avatar);
    row.appendChild(wrap);
  }

  chat.appendChild(row);

  if (window.MathJax && window.MathJax.typesetPromise) {
    window.MathJax.typesetPromise([bubble]).catch(()=>{});
  }

  const nearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 220;
  if (nearBottom || opts.forceScroll) scrollToBottom();

  saveChat();
}

let typingRow = null;
function showTyping(){
  if(typingRow) return;
  typingRow = document.createElement("div");
  typingRow.className = "row bot";

  const avatar = document.createElement("div");
  avatar.className = "avatar bot";
  avatar.textContent = "∑";

  const bubble = document.createElement("div");
  bubble.className = "typingBubble";
  bubble.innerHTML = `
    <div class="typingLine">
      <span>${I18N[lang].preparing}</span>
      <span class="dots"><span></span><span></span><span></span></span>
    </div>
  `;

  const wrap = document.createElement("div");
  wrap.className = "bubbleWrap";
  wrap.appendChild(bubble);

  typingRow.appendChild(avatar);
  typingRow.appendChild(wrap);

  chat.appendChild(typingRow);
  scrollToBottom();
}
function hideTyping(){
  if(!typingRow) return;
  typingRow.remove();
  typingRow = null;
}

function setBusy(b){
  sendBtn.disabled = b;
  input.disabled = b;
  statusText.textContent = b ? I18N[lang].busy : "";
}

function autoResize(){
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 140) + "px";
}
input.addEventListener("input", autoResize);
autoResize();

function getPrefs(){ return { lang, level: levelSel.value, mode: modeSel.value }; }
function applyChips(){
  const level = levelSel.value;
  const mode = modeSel.value;
  lvlChip.textContent = (LEVEL_LABELS[level] ? LEVEL_LABELS[level][lang] : "");
  modeChip.textContent = (MODE_LABELS[mode] ? MODE_LABELS[mode][lang] : "");
  pillStatus.textContent = `${lvlChip.textContent} • ${modeChip.textContent}`;
}
function savePrefs(){
  try{ localStorage.setItem(PREF_KEY, JSON.stringify(getPrefs())); }catch{}
}
function loadPrefs(){
  try{
    const p = JSON.parse(localStorage.getItem(PREF_KEY) || "null");
    if(!p) return;
    if(p.lang) lang = p.lang;
    if(p.level) levelSel.value = p.level;
    if(p.mode) modeSel.value = p.mode;
  }catch{}
}
levelSel.addEventListener("change", ()=>{ applyChips(); savePrefs(); });
modeSel.addEventListener("change", ()=>{ applyChips(); savePrefs(); });

function applyLang(next){
  lang = next;
  const t = I18N[lang];

  document.documentElement.lang = lang === "ar" ? "ar" : "en";
  document.documentElement.dir  = lang === "ar" ? "rtl" : "ltr";
  document.body.classList.toggle("ltr", lang === "en");

  document.getElementById("sideTitle").textContent = t.sideTitle;
  document.getElementById("sideSub").textContent = t.sideSub;
  document.getElementById("howTitle").textContent = t.howTitle;
  document.getElementById("howText").innerHTML = t.howText.replaceAll("\n","<br>");
  document.getElementById("langTitle").textContent = t.langTitle;

  document.getElementById("levelTitle").textContent = t.levelTitle;
  document.getElementById("lvlLabel").textContent = t.lvlLabel;
  document.getElementById("modeLabel").textContent = t.modeLabel;
  document.getElementById("levelHint").textContent = t.levelHint;

  /* ✅ FIX: header always shows teacher name */
  mainTitle.textContent = t.mainTitle;
  mainSub.textContent   = t.mainSub;

  clearBtn.textContent = t.clear;
  sendBtn.textContent = t.send;
  input.placeholder = t.placeholder;

  btnAr.classList.toggle("active", lang==="ar");
  btnEn.classList.toggle("active", lang==="en");

  applyChips();
  savePrefs();
}

btnAr.addEventListener("click", ()=>applyLang("ar"));
btnEn.addEventListener("click", ()=>applyLang("en"));

document.getElementById("pills").addEventListener("click", (e)=>{
  const pill = e.target.closest(".pill");
  if(!pill) return;
  input.value = pill.dataset.ex || "";
  input.focus();
  autoResize();
});

clearBtn.addEventListener("click", ()=>{
  chat.innerHTML = "";
  localStorage.removeItem(STORAGE_KEY);
  addMsg("bot", I18N[lang].cleared, {forceScroll:true});
});

function buildPrefix(){
  // helps force response language even if Worker ignores the field
  return (lang === "en")
    ? "Answer in English only. Math only. "
    : "أجب بالعربية فقط. رياضيات فقط. ";
}

async function send(){
  const q = input.value.trim();
  if(!q) return;

  if(!looksMathy(q)){
    showToast(I18N[lang].onlyMath);
    return;
  }

  const level = levelSel.value;
  const mode  = modeSel.value;

  addMsg("me", q, {forceScroll:true});
  input.value = "";
  autoResize();

  setBusy(true);
  await new Promise(r => setTimeout(r, 50));
  showTyping();

  try{
    const finalMessage = buildPrefix() + q;

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        message: finalMessage,
        language: lang,
        level: level,
        mode: mode
      })
    });

    const raw = await res.text();
    let data;
    try{ data = JSON.parse(raw); } catch { data = { answer: raw }; }

    hideTyping();
    const ans = (data.answer || "").toString().trim();
    addMsg("bot", ans || (lang==="ar" ? "لا يوجد رد واضح." : "No clear answer returned."), {forceScroll:true});

  }catch(e){
    hideTyping();
    addMsg("bot", lang==="ar" ? "تعذر الاتصال بالخادم." : "Connection failed.", {forceScroll:true});
  }finally{
    setBusy(false);
    scrollToBottom();
  }
}

sendBtn.addEventListener("click", send);
input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

function updateToTop(){
  const scrolled = chat.scrollTop > 280;
  toTopBtn.classList.toggle("show", scrolled);
}
chat.addEventListener("scroll", updateToTop, { passive:true });
toTopBtn.addEventListener("click", ()=>{ scrollToTopHard(); });
updateToTop();

function saveChat(){
  try{
    const items = [];
    chat.querySelectorAll(".row").forEach(row=>{
      const role = row.classList.contains("me") ? "me" : "bot";
      const bubble = row.querySelector(".bubble");
      const text = bubble ? bubble.textContent : "";
      items.push({ role, text });
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }catch{}
}
function loadChat(){
  try{
    const items = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
    if(!items || !Array.isArray(items) || items.length===0) return false;
    chat.innerHTML = "";
    items.forEach(it=> addMsg(it.role, it.text, {forceScroll:false}));
    return true;
  }catch{
    return false;
  }
}

/* init */
loadPrefs();
applyLang(lang);
applyChips();

const restored = loadChat();
if(!restored){
  addMsg("bot", I18N[lang].greeting, {forceScroll:true});
}else{
  showToast(I18N[lang].restored);
  scrollToBottom();
}
</script>

</body>
</html>
