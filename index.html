<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ø§Ø³Ø£Ù„ Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡</title>

<!-- Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- MathJax -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<style>
:root{
  --bg0:#050c18;
  --bg1:#071426;
  --panel:#0b1f3a;
  --panel2:#0f2a52;
  --line:rgba(255,255,255,.09);
  --text:#eaf2ff;
  --muted:#a2b4d8;
  --accent:#4da3ff;
  --accent2:#76c3ff;
  --meGrad: linear-gradient(135deg, #1e90ff, #4da3ff);
  --botBg:#122b52;
  --shadow: 0 28px 90px rgba(0,0,0,.55);
  --shadow2: 0 12px 35px rgba(0,0,0,.35);
  --r:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Cairo", system-ui, Segoe UI, Arial;
  background:
    radial-gradient(1200px 650px at 15% 10%, rgba(77,163,255,.18), transparent 55%),
    radial-gradient(900px 600px at 85% 15%, rgba(118,195,255,.12), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:14px;
}
.app{
  width:min(1200px,100%);
  min-height:100svh;
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:14px;
}
@media (max-width: 980px){
  .app{ grid-template-columns: 1fr; }
}

.side{
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius: calc(var(--r) + 6px);
  box-shadow: var(--shadow2);
  overflow:hidden;
}
.sideHeader{
  padding:16px 16px 12px;
  border-bottom:1px solid var(--line);
  background:
    radial-gradient(800px 260px at 15% 0%, rgba(77,163,255,.22), transparent 60%),
    radial-gradient(700px 260px at 90% 0%, rgba(118,195,255,.16), transparent 65%);
}
.brandRow{display:flex;gap:12px;align-items:center}
.badgeOrb{
  width:44px;height:44px;border-radius:14px;
  background: conic-gradient(from 180deg, #1e90ff, #76c3ff, #1e90ff);
  box-shadow: 0 0 0 6px rgba(77,163,255,.10), 0 18px 40px rgba(0,0,0,.45);
}
.sideTitle{margin:0;font-size:18px;font-weight:800}
.sideSub{margin:2px 0 0;font-size:13px;color:rgba(234,242,255,.75);line-height:1.6}
.sideBody{padding:14px 16px 16px}

.card{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  border-radius: var(--r);
  padding:14px;
  margin-top:12px;
}
.card h3{margin:0 0 8px;font-size:14px;color:#dbe7ff}
.card p{margin:0;color:rgba(234,242,255,.78);font-size:13px;line-height:1.75}

.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.pill{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:#eaf2ff;
  padding:8px 10px;
  border-radius:999px;
  font-size:12.5px;
  cursor:pointer;
  user-select:none;
  transition: transform .08s ease, background .15s ease;
}
.pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }

.langRow{display:flex;gap:8px;margin-top:10px}
.langBtn{
  flex:1;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:#eaf2ff;
  padding:10px 10px;
  border-radius: 999px;
  font-weight:800;
  cursor:pointer;
}
.langBtn.active{
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color:#041225;
  border-color: rgba(77,163,255,.35);
}

.chatPanel{
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius: calc(var(--r) + 6px);
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.chatHeader{
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  background: linear-gradient(90deg, rgba(77,163,255,.16), rgba(118,195,255,.08));
}
.chatHeaderLeft{display:flex;align-items:center;gap:10px;min-width:0}
.logo{
  width:40px;height:40px;border-radius:14px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  display:grid;place-items:center;
  font-weight:900;
}
.hTitle{margin:0;font-weight:900;font-size:16px}
.hSub{margin:0;color:rgba(234,242,255,.72);font-size:12.5px}

.headerBtns{display:flex;gap:8px;align-items:center}
.iconBtn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:#eaf2ff;
  padding:10px 12px;
  border-radius:999px;
  cursor:pointer;
  font-weight:900;
}
.iconBtn.danger{ border-color: rgba(255,77,90,.35); }

.chat{
  flex:1;
  padding:16px 14px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.row{ display:flex; gap:10px; }
.row.me{ justify-content:flex-start; }
.row.bot{ justify-content:flex-end; }

.bubble{
  max-width: 86%;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid var(--line);
  line-height:1.8;
  font-size:14.5px;
  white-space:pre-wrap;
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
}
.me .bubble{ background: var(--meGrad); color:#041225; border-color: rgba(77,163,255,.35); }
.bot .bubble{ background: linear-gradient(135deg, rgba(18,43,82,.95), rgba(18,43,82,.75)); }

.meta{
  font-size:12px;
  color:rgba(234,242,255,.55);
  margin-top:6px;
  display:flex;
  gap:8px;
  align-items:center;
}

.imgBubble{
  display:block;
  max-width: 260px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
}
.imgBubble img{width:100%;height:auto;display:block}

.typingBubble{
  max-width: 70%;
  padding:12px 12px;
  border-radius:16px;
  border:1px dashed rgba(77,163,255,.35);
  background: rgba(18,43,82,.55);
  color: rgba(234,242,255,.80);
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
}
.typingLine{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  font-weight:700;
}
.dots{display:inline-flex;gap:5px;align-items:center}
.dots span{
  width:7px;height:7px;border-radius:50%;
  background: var(--accent);
  animation: blink 1.1s infinite ease-in-out;
}
.dots span:nth-child(2){animation-delay:.15s}
.dots span:nth-child(3){animation-delay:.30s}
@keyframes blink{
  0%,100%{opacity:.25; transform: translateY(0);}
  50%{opacity:1; transform: translateY(-2px);}
}

.composer{
  padding:12px 12px 14px;
  border-top:1px solid var(--line);
  background: rgba(0,0,0,.12);
}
.composerRow{display:flex;gap:10px;align-items:flex-end}
.inputWrap{
  flex:1;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  border-radius: 18px;
  padding:10px 12px;
}
textarea{
  width:100%;
  border:none;
  outline:none;
  resize:none;
  background:transparent;
  color:var(--text);
  font-size:15px;
  line-height:1.7;
  min-height:44px;
  max-height:140px;
  font-family: "Cairo", system-ui, Segoe UI, Arial;
}
textarea::placeholder{ color: rgba(234,242,255,.55); }

.actionsCol{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width: 160px;
}
@media(max-width: 520px){
  .actionsCol{ min-width: 130px; }
}

.btn{
  border:none;
  cursor:pointer;
  border-radius: 14px;
  padding:11px 12px;
  font-weight:900;
  color:#041225;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 16px 35px rgba(77,163,255,.18);
}
.btn:disabled{ opacity:.55; cursor:not-allowed; }

.btn.secondary{
  background: rgba(255,255,255,.06);
  color: var(--text);
  border:1px solid var(--line);
  box-shadow:none;
}

.fileLabel{display:block;text-align:center;user-select:none}
.fileLabel input{display:none}

.preview{
  margin-top:8px;
  font-size:12.5px;
  color: rgba(234,242,255,.60);
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.kbdHint{
  margin-top:8px;
  font-size:12px;
  color: rgba(234,242,255,.55);
}
.kbd{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.20);
  padding:2px 6px;
  border-radius:8px;
  color: rgba(234,242,255,.85);
  font-size:11px;
  margin-inline:3px;
}
</style>
</head>

<body>

<div class="app">

  <aside class="side">
    <div class="sideHeader">
      <div class="brandRow">
        <div class="badgeOrb" aria-hidden="true"></div>
        <div style="min-width:0">
          <h2 class="sideTitle" id="sideTitle">Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡</h2>
          <p class="sideSub" id="sideSub">Ù…Ù†ØµØ© Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ù…ÙŠØ²Ø© â€¢ Ø´Ø±Ø­ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©</p>
        </div>
      </div>
    </div>

    <div class="sideBody">
      <div class="card">
        <h3 id="howTitle">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
        <p id="howText">
          â€¢ Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙˆØ¶ÙˆØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.<br>
          â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…ÙˆØ²: + âˆ’ Ã— Ã· Ùˆ ^.<br>
          â€¢ Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ø³ØªØ®Ø¯Ù… LaTeX Ù…Ø«Ù„: $\\frac{1}{2}$.<br>
          â€¢ Ø£Ø±Ø³Ù„ ØªÙ…Ø±ÙŠÙ†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ø¯Ù‚ÙŠÙ‚.
        </p>
        <div class="pills" id="pills">
          <span class="pill" data-ex="Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: 2x + 3 = 11">Ø­Ù„ Ù…Ø¹Ø§Ø¯Ù„Ø©</span>
          <span class="pill" data-ex="Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„ØªÙØ§Ø¶Ù„ÙŠØ©: y' = y">ØªÙØ§Ø¶Ù„ÙŠØ©</span>
          <span class="pill" data-ex="Ø§Ø´ØªÙ‚ Ø§Ù„Ø¯Ø§Ù„Ø©: f(x)=x^3 - 5x + 2">Ø§Ø´ØªÙ‚Ø§Ù‚</span>
          <span class="pill" data-ex="Ø¨Ø³Ù‘Ø·: (x^2-1)/(x-1)">ØªØ¨Ø³ÙŠØ·</span>
        </div>
      </div>

      <div class="card">
        <h3 id="langTitle">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©</h3>
        <div class="langRow">
          <button class="langBtn active" id="btnAr" type="button">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="langBtn" id="btnEn" type="button">English</button>
        </div>
      </div>

      <div class="card">
        <h3 id="noteTitle">Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
        <p id="noteText">
          Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙƒÙ…Ø¹Ø§ÙŠÙ†Ø©. Ø­Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙŠØ­ØªØ§Ø¬ ØªÙØ¹ÙŠÙ„ Ù„Ø§Ø­Ù‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Worker.
        </p>
      </div>
    </div>
  </aside>

  <main class="chatPanel">
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <div class="logo">âˆ‘</div>
        <div style="min-width:0">
          <p class="hTitle" id="mainTitle">Ø¬Ù„Ø³Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</p>
          <p class="hSub" id="mainSub">Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø´Ø±Ø­Ù‡ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©</p>
        </div>
      </div>

      <div class="headerBtns">
        <button class="iconBtn danger" id="clearBtn" type="button">Ù…Ø³Ø­</button>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="composer">
      <div class="composerRow">
        <div class="inputWrap">
          <textarea id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø§..."></textarea>
        </div>

        <div class="actionsCol">
          <button class="btn" id="sendBtn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>

          <label class="btn secondary fileLabel" id="uploadLabel">
            Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ†
            <input id="imageInput" type="file" accept="image/*">
          </label>
        </div>
      </div>

      <div class="preview">
        <span id="imgStatus"></span>
        <span id="statusText"></span>
      </div>

      <div class="kbdHint" id="kbdHint">
        Ù„Ù„Ø¥Ø±Ø³Ø§Ù„: <span class="kbd">Enter</span> â€” Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯: <span class="kbd">Shift</span> + <span class="kbd">Enter</span>
      </div>
    </div>
  </main>

</div>

<script>
const WORKER_URL = "https://ask-asmaa.ouchene-zinelaabidine.workers.dev";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const imgInput = document.getElementById("imageInput");
const imgStatus = document.getElementById("imgStatus");
const statusText = document.getElementById("statusText");

const btnAr = document.getElementById("btnAr");
const btnEn = document.getElementById("btnEn");

const I18N = {
  ar: {
    sideTitle: "Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡",
    sideSub: "Ù…Ù†ØµØ© Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ù…ÙŠØ²Ø© â€¢ Ø´Ø±Ø­ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©",
    howTitle: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„",
    howText:
`â€¢ Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙˆØ¶ÙˆØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…ÙˆØ²: + âˆ’ Ã— Ã· Ùˆ ^.
â€¢ Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ø³ØªØ®Ø¯Ù… LaTeX Ù…Ø«Ù„: $\\frac{1}{2}$.
â€¢ Ø£Ø±Ø³Ù„ ØªÙ…Ø±ÙŠÙ†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ø¯Ù‚ÙŠÙ‚.`,
    langTitle: "Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©",
    noteTitle: "Ù…Ù„Ø§Ø­Ø¸Ø©",
    noteText: "Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙƒÙ…Ø¹Ø§ÙŠÙ†Ø©. Ø­Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙŠØ­ØªØ§Ø¬ ØªÙØ¹ÙŠÙ„ Ù„Ø§Ø­Ù‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Worker.",
    mainTitle: "Ø¬Ù„Ø³Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",
    mainSub: "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø´Ø±Ø­Ù‡ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©",
    clear: "Ù…Ø³Ø­",
    send: "Ø¥Ø±Ø³Ø§Ù„",
    upload: "Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ†",
    placeholder: "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø§...",
    greeting: "Ø£Ù‡Ù„Ù‹Ø§ Ø¨Ùƒ! Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙˆØ³Ø£Ø´Ø±Ø­Ù‡ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.",
    cleared: "ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. Ø§Ø¨Ø¯Ø£ ØªÙ…Ø±ÙŠÙ†Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.",
    preparing: "Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡ ØªÙØ­Ø¶Ù‘Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
    imgPicked: "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©",
    busy: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."
  },
  en: {
    sideTitle: "Ms. Asmaa",
    sideSub: "Math platform â€¢ Step-by-step explanations",
    howTitle: "How to ask",
    howText:
`â€¢ Write your question clearly.
â€¢ You can use symbols: + âˆ’ Ã— Ã· and ^.
â€¢ For fractions use LaTeX: $\\frac{1}{2}$.
â€¢ Send one exercise at a time for best accuracy.`,
    langTitle: "Language",
    noteTitle: "Note",
    noteText: "The image is shown in chat as a preview. Solving the image requires enabling it in the Worker later.",
    mainTitle: "Math Session",
    mainSub: "Type your question and get a step-by-step solution",
    clear: "Clear",
    send: "Send",
    upload: "Upload exercise image",
    placeholder: "Type your math question here...",
    greeting: "Welcome! Type your math question and Iâ€™ll explain it step by step.",
    cleared: "Chat cleared. Start a new exercise.",
    preparing: "Ms. Asmaa is preparing the answer",
    imgPicked: "Image selected",
    busy: "Sending..."
  }
};

let lang = "ar";

function nowTime(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
function scrollToBottom(){
  chat.scrollTop = chat.scrollHeight;
}

function addMsg(role, text){
  const row = document.createElement("div");
  row.className = "row " + (role === "me" ? "me" : "bot");

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span>${role === "me" ? (lang==="ar"?"Ø£Ù†Øª":"You") : (lang==="ar"?"Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡":"Ms. Asmaa")}</span> â€¢ <span>${nowTime()}</span>`;

  const wrap = document.createElement("div");
  wrap.appendChild(bubble);
  wrap.appendChild(meta);

  row.appendChild(wrap);
  chat.appendChild(row);
  scrollToBottom();

  if (window.MathJax && window.MathJax.typesetPromise) {
    window.MathJax.typesetPromise([bubble]).catch(()=>{});
  }
}

/* âœ… show image inside chat (preview) */
function addImageToChat(file){
  const row = document.createElement("div");
  row.className = "row me";

  const wrap = document.createElement("div");

  const imgBox = document.createElement("div");
  imgBox.className = "imgBubble";

  const img = document.createElement("img");
  img.alt = "Exercise image";

  const url = URL.createObjectURL(file);
  img.src = url;

  imgBox.appendChild(img);
  wrap.appendChild(imgBox);

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span>${lang==="ar"?"Ø£Ù†Øª":"You"}</span> â€¢ <span>${nowTime()}</span>`;
  wrap.appendChild(meta);

  row.appendChild(wrap);
  chat.appendChild(row);
  scrollToBottom();

  // You can revoke later if you want:
  // setTimeout(()=>URL.revokeObjectURL(url), 60000);
}

/* Typing bubble */
let typingRow = null;
function showTyping(){
  if(typingRow) return;
  typingRow = document.createElement("div");
  typingRow.className = "row bot";
  const bubble = document.createElement("div");
  bubble.className = "typingBubble";
  bubble.innerHTML = `
    <div class="typingLine">
      <span>${I18N[lang].preparing}</span>
      <span class="dots"><span></span><span></span><span></span></span>
    </div>
  `;
  typingRow.appendChild(bubble);
  chat.appendChild(typingRow);
  scrollToBottom();
}
function hideTyping(){
  if(!typingRow) return;
  typingRow.remove();
  typingRow = null;
}

function setBusy(b){
  sendBtn.disabled = b;
  input.disabled = b;
  statusText.textContent = b ? I18N[lang].busy : "";
}

async function send(){
  const q = input.value.trim();
  if(!q) return;

  addMsg("me", q);
  input.value = "";
  autoResize();

  setBusy(true);

  // Mobile reflow fix
  await new Promise(r => setTimeout(r, 50));

  showTyping();

  try{
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ message: q })
    });

    const raw = await res.text();
    let data;
    try{ data = JSON.parse(raw); } catch { data = { answer: raw }; }

    hideTyping();
    addMsg("bot", (data.answer || "").toString().trim() || (lang==="ar" ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯ ÙˆØ§Ø¶Ø­." : "No clear answer returned."));
  }catch(e){
    hideTyping();
    addMsg("bot", lang==="ar" ? "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…." : "Connection failed.");
  }finally{
    setBusy(false);
    scrollToBottom();
  }
}

/* Language */
function applyLang(next){
  lang = next;
  const t = I18N[lang];

  document.getElementById("sideTitle").textContent = t.sideTitle;
  document.getElementById("sideSub").textContent = t.sideSub;
  document.getElementById("howTitle").textContent = t.howTitle;
  document.getElementById("howText").innerHTML = t.howText.replaceAll("\n","<br>");
  document.getElementById("langTitle").textContent = t.langTitle;
  document.getElementById("noteTitle").textContent = t.noteTitle;
  document.getElementById("noteText").textContent = t.noteText;
  document.getElementById("mainTitle").textContent = t.mainTitle;
  document.getElementById("mainSub").textContent = t.mainSub;

  clearBtn.textContent = t.clear;
  sendBtn.textContent = t.send;
  document.getElementById("uploadLabel").childNodes[0].textContent = t.upload + " ";

  input.placeholder = t.placeholder;

  btnAr.classList.toggle("active", lang==="ar");
  btnEn.classList.toggle("active", lang==="en");
}

/* âœ… FIX: language buttons click handlers */
btnAr.addEventListener("click", ()=>applyLang("ar"));
btnEn.addEventListener("click", ()=>applyLang("en"));

/* Image pick: show preview + bubble in chat */
imgInput.addEventListener("change", ()=>{
  const f = imgInput.files && imgInput.files[0];
  if(!f){
    imgStatus.textContent = "";
    return;
  }
  imgStatus.innerHTML = `ğŸ“· <b>${I18N[lang].imgPicked}</b>: ${f.name}`;

  // show image preview bubble in chat
  addImageToChat(f);

  // optional: add a note message to user
  addMsg("bot", lang==="ar"
    ? "ÙˆØµÙ„ØªÙ†ÙŠ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ…Ø¹Ø§ÙŠÙ†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©. Ù„Ø­Ù„ Ø§Ù„ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù†Ø­ØªØ§Ø¬ ØªÙØ¹ÙŠÙ„ Ø°Ù„Ùƒ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Worker."
    : "Image received as a preview in chat. To solve the image automatically, we need to enable it in the Worker."
  );
});

/* Clear */
clearBtn.addEventListener("click", ()=>{
  chat.innerHTML = "";
  addMsg("bot", I18N[lang].cleared);
});

/* Pills */
document.getElementById("pills").addEventListener("click", (e)=>{
  const pill = e.target.closest(".pill");
  if(!pill) return;
  input.value = pill.dataset.ex || "";
  input.focus();
  autoResize();
});

/* Send */
sendBtn.addEventListener("click", send);
input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

/* Autosize */
function autoResize(){
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 140) + "px";
}
input.addEventListener("input", autoResize);
autoResize();

/* Init */
applyLang("ar");
addMsg("bot", I18N[lang].greeting);
</script>
</body>
</html>
