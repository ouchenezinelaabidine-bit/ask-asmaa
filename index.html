<!-- =========================
PART 1 / 2  (Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø£ÙˆÙ„Ø§Ù‹)
========================= -->
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ø§Ø³Ø£Ù„ Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- MathJax (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
<script>
window.MathJax = {
  tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
  options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<style>
:root{
  --bg0:#050c18;
  --bg1:#071426;
  --panel:#0b1f3a;
  --line:rgba(255,255,255,.09);
  --text:#eaf2ff;
  --muted:#a2b4d8;
  --accent:#4da3ff;
  --accent2:#76c3ff;

  --meGrad: linear-gradient(135deg, #1e90ff, #4da3ff);
  --botBg: rgba(18,43,82,.92);

  --shadow: 0 28px 90px rgba(0,0,0,.55);
  --shadow2: 0 12px 35px rgba(0,0,0,.35);
  --r:18px;

  --waA: rgba(77,163,255,.08);
  --waB: rgba(118,195,255,.06);
}
*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:"Cairo", system-ui, Segoe UI, Arial;
  background:
    radial-gradient(1200px 650px at 15% 10%, rgba(77,163,255,.18), transparent 55%),
    radial-gradient(900px 600px at 85% 15%, rgba(118,195,255,.12), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  color:var(--text);
  display:block;
  padding:14px;
  min-height:100vh;
  min-height:100dvh;
}

.app{
  width:min(1200px,100%);
  margin:0 auto;
  min-height:calc(100vh - 28px);
  min-height:calc(100dvh - 28px);
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:14px;
}
@media (max-width: 980px){
  .app{ grid-template-columns: 1fr; }
}

/* side */
.side{
  height:100%;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius: calc(var(--r) + 6px);
  box-shadow: var(--shadow2);
  overflow:hidden;
}
.sideHeader{
  padding:16px 16px 12px;
  border-bottom:1px solid var(--line);
  background:
    radial-gradient(800px 260px at 15% 0%, rgba(77,163,255,.22), transparent 60%),
    radial-gradient(700px 260px at 90% 0%, rgba(118,195,255,.16), transparent 65%);
}
.brandRow{display:flex;gap:12px;align-items:center}
.badgeOrb{
  width:44px;height:44px;border-radius:14px;
  background: conic-gradient(from 180deg, #1e90ff, #76c3ff, #1e90ff);
  box-shadow: 0 0 0 6px rgba(77,163,255,.10), 0 18px 40px rgba(0,0,0,.45);
}
.sideTitle{margin:0;font-size:18px;font-weight:800}
.sideSub{margin:2px 0 0;font-size:13px;color:rgba(234,242,255,.75);line-height:1.6}
.sideBody{padding:14px 16px 16px}

.card{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  border-radius: var(--r);
  padding:14px;
  margin-top:12px;
}
.card h3{margin:0 0 8px;font-size:14px;color:#dbe7ff}
.card p{margin:0;color:rgba(234,242,255,.78);font-size:13px;line-height:1.75}

.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.pill{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:#eaf2ff;
  padding:8px 10px;
  border-radius:999px;
  font-size:12.5px;
  cursor:pointer;
  user-select:none;
  transition: transform .08s ease, background .15s ease;
}
.pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }

.langRow{display:flex;gap:8px;margin-top:10px}
.langBtn{
  flex:1;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color:#eaf2ff;
  padding:10px 10px;
  border-radius: 999px;
  font-weight:800;
  cursor:pointer;
}
.langBtn.active{
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color:#041225;
  border-color: rgba(77,163,255,.35);
}

/* selectors */
.selectGrid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
  margin-top:10px;
}
.selLabel{
  font-size:12.5px;
  color:rgba(234,242,255,.78);
  margin-bottom:6px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.selectWrap{
  border:1px solid var(--line);
  background: rgba(0,0,0,.20);
  border-radius: 14px;
  padding:10px 10px;
}
select{
  width:100%;
  border:none;
  outline:none;
  background:transparent;
  color:var(--text);
  font-family:"Cairo", system-ui, Segoe UI, Arial;
  font-weight:800;
  font-size:13.5px;
}
option{ color:#071426; }

.smallHint{
  font-size:12px;
  color:rgba(234,242,255,.60);
  line-height:1.6;
  margin-top:8px;
}

/* chat panel */
.chatPanel{
  height:100%;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius: calc(var(--r) + 6px);
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  position:relative;
}
.chatHeader{
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  background: linear-gradient(90deg, rgba(77,163,255,.16), rgba(118,195,255,.08));
}
.chatHeaderLeft{display:flex;align-items:center;gap:10px;min-width:0}
.logo{
  width:40px;height:40px;border-radius:14px;
  background: rgba(255,255,255,.06);
  border:1px solid var(--line);
  display:grid;place-items:center;
  font-weight:900;
}
.hTitle{margin:0;font-weight:900;font-size:16px}
.hSub{margin:0;color:rgba(234,242,255,.72);font-size:12.5px}

/* chat */
.chat{
  flex:1;
  padding:16px 14px;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:12px;
  scroll-behavior:auto;
  -webkit-overflow-scrolling: touch;

  background:
    radial-gradient(220px 160px at 15% 20%, var(--waA), transparent 60%),
    radial-gradient(240px 180px at 80% 35%, var(--waB), transparent 60%),
    radial-gradient(220px 160px at 30% 85%, var(--waB), transparent 60%),
    linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.14));
}

/* messages layout */
.row{ display:flex; gap:10px; align-items:flex-end; }
.row.me{ justify-content:flex-end; }
.row.bot{ justify-content:flex-start; }

.avatar{
  width:32px;height:32px;border-radius:12px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  display:grid;place-items:center;
  font-weight:900;
  flex:0 0 auto;
}
.avatar.me{ background: rgba(77,163,255,.12); }
.avatar.bot{ background: rgba(255,255,255,.06); }

.bubbleWrap{max-width: 86%; display:flex; flex-direction:column; gap:6px; position:relative;}
.bubble{
  padding:12px 12px;
  border-radius:18px;
  border:1px solid var(--line);
  line-height:1.85;
  font-size:14.5px;
  white-space:pre-wrap;
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
}

.bubble::after{
  content:"";
  position:absolute;
  bottom:10px;
  width:14px;height:14px;
  transform: rotate(45deg);
  border-radius:3px;
  opacity:.95;
}
.row.me .bubble::after{ right:-6px; background: #2b9bff; border-right:1px solid rgba(77,163,255,.18); border-bottom:1px solid rgba(77,163,255,.18); }
.row.bot .bubble::after{ left:-6px; background: rgba(18,43,82,.92); border-left:1px solid rgba(255,255,255,.07); border-bottom:1px solid rgba(255,255,255,.07); }

.row.me .bubble{ background: var(--meGrad); color:#041225; border-color: rgba(77,163,255,.35); }
.row.bot .bubble{ background: var(--botBg); }

.meta{
  font-size:12px;
  color:rgba(234,242,255,.55);
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.meta .leftMeta{display:flex;gap:8px;align-items:center}
.meta .rightMeta{display:flex;gap:8px;align-items:center}
.miniBtn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.06);
  color: var(--text);
  padding:5px 8px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
  font-weight:800;
}
.miniBtn:hover{ background: rgba(255,255,255,.10); }

.typingBubble{
  max-width: 70%;
  padding:12px 12px;
  border-radius:18px;
  border:1px dashed rgba(77,163,255,.35);
  background: rgba(18,43,82,.55);
  color: rgba(234,242,255,.85);
  box-shadow: 0 10px 24px rgba(0,0,0,.22);
}
.typingLine{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  font-weight:800;
}
.dots{display:inline-flex;gap:5px;align-items:center}
.dots span{
  width:7px;height:7px;border-radius:50%;
  background: var(--accent);
  animation: blink 1.1s infinite ease-in-out;
}
.dots span:nth-child(2){animation-delay:.15s}
.dots span:nth-child(3){animation-delay:.30s}
@keyframes blink{
  0%,100%{opacity:.25; transform: translateY(0);}
  50%{opacity:1; transform: translateY(-2px);}
}

/* composer */
.composer{
  padding:12px 12px 14px;
  border-top:1px solid var(--line);
  background: rgba(0,0,0,.12);
}
.composerRow{display:flex;gap:10px;align-items:flex-end}
.inputWrap{
  flex:1;
  border:1px solid var(--line);
  background: rgba(0,0,0,.22);
  border-radius: 18px;
  padding:10px 12px;
}
textarea{
  width:100%;
  border:none;
  outline:none;
  resize:none;
  background:transparent;
  color:var(--text);
  font-size:15px;
  line-height:1.7;
  min-height:44px;
  max-height:140px;
  font-family: "Cairo", system-ui, Segoe UI, Arial;
}
textarea::placeholder{ color: rgba(234,242,255,.55); }

.actionsCol{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width: 170px;
}
@media(max-width: 520px){
  .actionsCol{ min-width: 140px; }
}
.btn{
  border:none;
  cursor:pointer;
  border-radius: 14px;
  padding:11px 12px;
  font-weight:900;
  color:#041225;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  box-shadow: 0 16px 35px rgba(77,163,255,.18);
}
.btn:disabled{ opacity:.55; cursor:not-allowed; }
.btn.secondary{
  background: rgba(255,255,255,.06);
  color: var(--text);
  border:1px solid var(--line);
  box-shadow:none;
}

.preview{
  margin-top:8px;
  font-size:12.5px;
  color: rgba(234,242,255,.60);
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.kbdHint{
  margin-top:8px;
  font-size:12px;
  color: rgba(234,242,255,.55);
}
.kbd{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.20);
  padding:2px 6px;
  border-radius:8px;
  color: rgba(234,242,255,.85);
  font-size:11px;
  margin-inline:3px;
}

/* Scroll-to-top */
.toTop{
  position:absolute;
  left:14px;
  bottom:92px;
  width:46px;
  height:46px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.35);
  color: var(--text);
  display:grid;
  place-items:center;
  cursor:pointer;
  box-shadow: 0 16px 35px rgba(0,0,0,.35);
  opacity:0;
  pointer-events:none;
  transform: translateY(8px);
  transition: opacity .2s ease, transform .2s ease, background .15s ease;
  z-index:5;
}
.toTop:hover{ background: rgba(255,255,255,.06); }
.toTop.show{ opacity:1; pointer-events:auto; transform: translateY(0); }
.toTop span{ font-size:18px; font-weight:900; line-height:1; }

.toast{
  position:absolute;
  top:14px;
  right:14px;
  background: rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.10);
  color: rgba(234,242,255,.92);
  padding:10px 12px;
  border-radius: 14px;
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  opacity:0;
  transform: translateY(-6px);
  transition: opacity .18s ease, transform .18s ease;
  z-index:10;
  font-size:13px;
  font-weight:800;
}
.toast.show{ opacity:1; transform: translateY(0); }

/* rtl / ltr */
body.ltr{ direction:ltr; }
body.ltr .toTop{ left:auto; right:14px; }
body.ltr .toast{ right:auto; left:14px; }
</style>
</head>

<body>

<div class="app">

  <aside class="side">
    <div class="sideHeader">
      <div class="brandRow">
        <div class="badgeOrb" aria-hidden="true"></div>
        <div style="min-width:0">
          <h2 class="sideTitle" id="sideTitle">Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡</h2>
          <p class="sideSub" id="sideSub">Ù…Ù†ØµØ© Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ù…ÙŠØ²Ø© â€¢ Ø´Ø±Ø­ ÙˆØ§Ø¶Ø­</p>
        </div>
      </div>
    </div>

    <div class="sideBody">
      <div class="card">
        <h3 id="howTitle">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
        <p id="howText">
          â€¢ Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙˆØ¶ÙˆØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.<br>
          â€¢ Ø£Ø±Ø³Ù„ ØªÙ…Ø±ÙŠÙ†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ø¯Ù‚ÙŠÙ‚.
        </p>
        <div class="pills" id="pills"></div>
        <div class="smallHint" id="pillHint"></div>
      </div>

      <div class="card">
        <h3 id="langTitle">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©</h3>
        <div class="langRow">
          <button class="langBtn active" id="btnAr" type="button">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
          <button class="langBtn" id="btnEn" type="button">English</button>
        </div>
      </div>

      <div class="card">
        <h3 id="levelTitle">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</h3>
        <div class="selectGrid">
          <div>
            <div class="selLabel"><span id="lvlLabel">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ø§Ù„Ø¨</span><span id="lvlChip" style="color:rgba(234,242,255,.65);font-size:12px;font-weight:900;"></span></div>
            <div class="selectWrap">
              <select id="level">
                <option value="primary">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="middle">Ù…ØªÙˆØ³Ø·</option>
                <option value="high">Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="uni">Ø¬Ø§Ù…Ø¹ÙŠ</option>
              </select>
            </div>
          </div>

          <div>
            <div class="selLabel"><span id="modeLabel">Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</span><span id="modeChip" style="color:rgba(234,242,255,.65);font-size:12px;font-weight:900;"></span></div>
            <div class="selectWrap">
              <select id="mode">
                <option value="simple">Ø´Ø±Ø­ Ù…Ø¨Ø³Ø·</option>
                <option value="steps">Ø­Ù„ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©</option>
                <option value="final">Ø§Ù„Ø¬ÙˆØ§Ø¨ ÙÙ‚Ø·</option>
                <option value="quiz">Ø§Ø®ØªØ¨Ø±Ù†ÙŠ Ø«Ù… ØµØ­Ø­</option>
              </select>
            </div>
          </div>
        </div>
        <div class="smallHint" id="levelHint">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ù…Ù†Ø§Ø³Ø¨.</div>
      </div>

      <div class="card">
        <h3 id="noteTitle">Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
        <p id="noteText">ÙƒÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙÙ‚Ø·ØŒ ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ ÙˆØ§Ø¶Ø­ ÙˆØ±Ù…ÙˆØ² Ø³Ù‡Ù„Ø©.</p>
      </div>
    </div>
  </aside>

  <main class="chatPanel">
    <div class="chatHeader">
      <div class="chatHeaderLeft">
        <div class="logo">âˆ‘</div>
        <div style="min-width:0">
          <p class="hTitle" id="mainTitle">Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡</p>
          <p class="hSub" id="mainSub">Ø¬Ù„Ø³Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€¢ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø´Ø±Ø­Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</p>
        </div>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div id="toast" class="toast"></div>

    <button id="toTop" class="toTop" type="button" aria-label="Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ø¹Ù„Ù‰">
      <span>â†‘</span>
    </button>

    <div class="composer">
      <div class="composerRow">
        <div class="inputWrap">
          <textarea id="input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø§..."></textarea>
        </div>

        <div class="actionsCol">
          <button class="btn" id="sendBtn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
          <button class="btn secondary" id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>
      </div>

      <div class="preview">
        <span id="statusText"></span>
        <span id="pillStatus" style="font-weight:900;"></span>
      </div>

      <div class="kbdHint" id="kbdHint">
        Ù„Ù„Ø¥Ø±Ø³Ø§Ù„: <span class="kbd">Enter</span> â€” Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯: <span class="kbd">Shift</span> + <span class="kbd">Enter</span>
      </div>
    </div>
  </main>

</div>

<script>
const WORKER_URL = "https://ask-asmaa.ouchene-zinelaabidine.workers.dev";

const STORAGE_KEY = "asmaa_chat_v4";
const PREF_KEY = "asmaa_prefs_v4";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const statusText = document.getElementById("statusText");
const pillStatus = document.getElementById("pillStatus");

const btnAr = document.getElementById("btnAr");
const btnEn = document.getElementById("btnEn");
const toTopBtn = document.getElementById("toTop");
const toast = document.getElementById("toast");

const levelSel = document.getElementById("level");
const modeSel = document.getElementById("mode");
const lvlChip = document.getElementById("lvlChip");
const modeChip = document.getElementById("modeChip");

const mainTitle = document.getElementById("mainTitle");
const mainSub   = document.getElementById("mainSub");

let lang = "ar";

const I18N = {
  ar: {
    sideTitle: "Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡",
    sideSub: "Ù…Ù†ØµØ© Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…Ù…ÙŠØ²Ø© â€¢ Ø°ÙƒØ§Ø¡ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",
    howTitle: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„",
    howText:
`â€¢ Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨ÙˆØ¶ÙˆØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.
â€¢ Ø£Ø±Ø³Ù„ ØªÙ…Ø±ÙŠÙ†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ø¯Ù‚ÙŠÙ‚.`,
    pillHint: "Ø£Ù…Ø«Ù„Ø© Ø³Ø±ÙŠØ¹Ø© (Ø§Ø¶ØºØ· Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„):",
    langTitle: "Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©",
    levelTitle:"Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
    lvlLabel:"Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ø§Ù„Ø¨",
    modeLabel:"Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
    levelHint:"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø´Ø±Ø­ Ù…Ù†Ø§Ø³Ø¨.",
    mainTitle: "Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡",
    mainSub: "Ø¬Ù„Ø³Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€¢ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ³Ø£Ø´Ø±Ø­Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
    clear: "Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©",
    send: "Ø¥Ø±Ø³Ø§Ù„",
    placeholder: "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‡Ù†Ø§...",
    greeting: "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹\nØ§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ù‹Ø§ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª (Ø­ØªÙ‰ Ù„Ùˆ Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²) ÙˆØ³Ø£Ø´Ø±Ø­Ù‡ Ø¨ÙˆØ¶ÙˆØ­.",
    cleared: "ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© âœ… Ø§Ø¨Ø¯Ø£ ØªÙ…Ø±ÙŠÙ†Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.",
    preparing: "Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡ ØªÙØ­Ø¶Ù‘Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©",
    busy: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...",
    onlyMath: "Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ ğŸŒŸ\nØ£Ù†Ø§ Ù…Ø®ØªØµØ© Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙÙ‚Ø·ØŒ Ù„Ø°Ù„Ùƒ Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ù‹Ø§ ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø¨ÙƒÙ„ Ø³Ø±ÙˆØ±.",
    copied: "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…",
    restored: "ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© âœ…",
    noAnswer: "Ù„Ù… ÙŠØµÙ„Ù†ÙŠ Ø±Ø¯ ÙˆØ§Ø¶Ø­. Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ© Ø§Ù„Ø³Ø¤Ø§Ù„."
  },
  en: {
    sideTitle: "Ms. Asmaa",
    sideSub: "Math-only AI â€¢ Clear explanations",
    howTitle: "How to ask",
    howText:
`â€¢ Write your question clearly.
â€¢ Send one exercise at a time for best accuracy.`,
    pillHint: "Quick examples (tap to insert):",
    langTitle: "Language",
    levelTitle:"Level",
    lvlLabel:"Choose student level",
    modeLabel:"Answer style",
    levelHint:"Pick level & style before sending for a better explanation.",
    mainTitle: "Ms. Asmaa",
    mainSub: "Math session â€¢ Ask and get a level-based explanation",
    clear: "Clear chat",
    send: "Send",
    placeholder: "Type your math question here...",
    greeting: "Welcome ğŸ‘‹\nAsk any math question (even without symbols) and Iâ€™ll explain it clearly.",
    cleared: "Chat cleared âœ… Start a new exercise.",
    preparing: "Ms. Asmaa is preparing the answer",
    busy: "Sending...",
    onlyMath: "Thank you ğŸŒŸ\nI specialize in mathematics only, so I canâ€™t answer this kind of message. Please ask a math question and Iâ€™ll be happy to help.",
    copied: "Copied âœ…",
    restored: "Chat restored âœ…",
    noAnswer: "No clear answer returned. Try rephrasing the question."
  }
};

const LEVEL_LABELS = {
  primary: { ar:"Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", en:"Primary" },
  middle:  { ar:"Ù…ØªÙˆØ³Ø·",  en:"Middle"  },
  high:    { ar:"Ø«Ø§Ù†ÙˆÙŠ",  en:"High school" },
  uni:     { ar:"Ø¬Ø§Ù…Ø¹ÙŠ",  en:"University" }
};
const MODE_LABELS = {
  simple: { ar:"Ø´Ø±Ø­ Ù…Ø¨Ø³Ø·", en:"Simple explanation" },
  steps:  { ar:"Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©", en:"Step-by-step" },
  final:  { ar:"Ø§Ù„Ø¬ÙˆØ§Ø¨ ÙÙ‚Ø·", en:"Final answer only" },
  quiz:   { ar:"Ø§Ø®ØªØ¨Ø±Ù†ÙŠ Ø«Ù… ØµØ­Ø­", en:"Quiz me & correct" }
};
function nowTime(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1200);
}
function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }
function scrollToTopHard(){
  chat.scrollTop = 0;
  requestAnimationFrame(()=>{ chat.scrollTop = 0; });
  window.scrollTo({ top:0, left:0, behavior:"auto" });
}

/* ===== Ø±Ù…ÙˆØ² ÙˆØ§Ø¶Ø­Ø© ===== */
const SUP_MAP = {'0':'â°','1':'Â¹','2':'Â²','3':'Â³','4':'â´','5':'âµ','6':'â¶','7':'â·','8':'â¸','9':'â¹'};
function toSupDigits(s){ return s.split("").map(ch => SUP_MAP[ch] || ch).join(""); }
function prettifyMathText(text){
  let s = (text || "").toString();
  s = s.replace(/```[\s\S]*?```/g, (blk)=> blk.replace(/```/g,""));
  s = s.replace(/sqrt\s*\(\s*([^)]+?)\s*\)/gi, (m, inside)=> `âˆš(${inside.trim()})`);
  s = s.replace(/\^([0-9]{2,})/g, (m, ds)=> toSupDigits(ds));
  s = s.replace(/\^([0-9])/g, (m, d)=> SUP_MAP[d] || m);
  s = s.replace(/([0-9\u0660-\u0669\u06F0-\u06F9]+)\s*\/\s*([0-9\u0660-\u0669\u06F0-\u06F9]+)/g, "$1â„$2");
  s = s.replace(/(\d|\)|[a-zA-Z\u0621-\u064A])\s*\*\s*(\d|\(|[a-zA-Z\u0621-\u064A])/g, "$1 Ã— $2");
  s = s.replace(/(\d|\)|[a-zA-Z\u0621-\u064A])\s*\/\s*(\d|\(|[a-zA-Z\u0621-\u064A])/g, "$1 Ã· $2");
  s = s.replace(/<=/g,"â‰¤").replace(/>=/g,"â‰¥");
  return s.trim();
}

/* ===== ØªÙ…ÙŠÙŠØ² Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù‚ÙˆÙŠ (ÙŠØ´Ù…Ù„ Ø§Ù„ØªÙØ§Ø¶Ù„/Ø§Ù„ØªÙƒØ§Ù…Ù„/ODE/PDE/ØªØ±Ø¨ÙŠØ¹ÙŠØ©...) ===== */
function hasMathSignals(text){
  const s = (text || "").toString();
  const digitAny = /[0-9\u0660-\u0669\u06F0-\u06F9]/;
  const sym = /[+\-*/^=()Ã—Ã·âˆšÏ€âˆâˆ«âˆ‘â‰¤â‰¥]/;
  const vars = /\b(x|y|z|t|n|k|a|b|c|sin|cos|tan|log|ln)\b/i;

  const wordsAr = /(Ø±ÙŠØ§Ø¶ÙŠØ§Øª|Ù…Ø³Ø£Ù„Ø©|ØªÙ…Ø±ÙŠÙ†|Ø­Ù„|Ø§Ø­Ø³Ø¨|Ø£Ø­Ø³Ø¨|Ø§ÙˆØ¬Ø¯|Ø£ÙˆØ¬Ø¯|Ø¨Ø³Ø·|Ø¨Ø³Ù‘Ø·|ØªØ¨Ø³ÙŠØ·|Ø§Ø®ØªØ²Ù„|ÙƒØ³Ø±|ÙƒØ³ÙˆØ±|Ù†Ø³Ø¨Ø©|ØªÙ†Ø§Ø³Ø¨|Ù…Ø¹Ø§Ø¯Ù„Ø©|Ù…Ø¹Ø§Ø¯Ù„Ø§Øª|ØªØ±Ø¨ÙŠØ¹ÙŠØ©|Ù…Ù† Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©|Ø¯Ø±Ø¬Ø© Ø«Ø§Ù†ÙŠØ©|Ù…ØªØ¨Ø§ÙŠÙ†Ø©|Ù…ØªØ±Ø§Ø¬Ø­Ø©|Ø¯Ø§Ù„Ø©|Ù…Ø´ØªÙ‚Ø©|Ø§Ø´ØªÙ‚Ø§Ù‚|Ø§Ø´ØªÙ‚|ØªÙØ§Ø¶Ù„|ØªÙƒØ§Ù…Ù„|Ù†Ù‡Ø§ÙŠØ©|Ù…ØªØªØ§Ù„ÙŠØ©|Ù…ØªØ³Ù„Ø³Ù„Ø©|Ø§Ø­ØªÙ…Ø§Ù„|Ø¥Ø­ØµØ§Ø¡|Ù‡Ù†Ø¯Ø³Ø©|Ø²Ø§ÙˆÙŠØ©|Ù…Ø«Ù„Ø«|Ù…Ø±Ø¨Ø¹|Ø¯Ø§Ø¦Ø±Ø©|Ù…Ø­ÙŠØ·|Ù…Ø³Ø§Ø­Ø©|Ø­Ø¬Ù…|Ù‚Ø·Ø±|Ù†ØµÙ Ù‚Ø·Ø±|Ø¬Ø°Ø±|Ø£Ø³|Ù‚ÙˆØ©|Ù„ÙˆØºØ§Ø±ÙŠØªÙ…|Ù…ØµÙÙˆÙØ©|Ù…ØªØ¬Ù‡|Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª|Ù…ÙŠÙ„|Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©|ØªÙØ§Ø¶Ù„ÙŠØ©|Ù…Ø¹Ø§Ø¯Ù„Ø© ØªÙØ§Ø¶Ù„ÙŠØ©|ODE|PDE)/i;

  const wordsEn = /(math|problem|exercise|solve|compute|calculate|simplify|factor|equation|quadratic|second degree|inequality|function|derivative|integral|limit|probability|statistics|geometry|algebra|matrix|vector|trigonometry|sqrt|power|exponent|logarithm|coordinate|slope|percentage|differential equation|ode|pde)/i;

  return (digitAny.test(s) && sym.test(s)) || sym.test(s) || vars.test(s) || wordsAr.test(s) || wordsEn.test(s);
}

/* Ù†Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶Ù‹Ø§ â€œØ´Ø¯ÙŠØ¯ Ø§Ù„ØµØ±Ø§Ù…Ø©â€ ÙÙ‚Ø·: Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙˆØ§Ø¶Ø­ ØºÙŠØ± Ø±ÙŠØ§Ø¶ÙŠ  */
function isClearlyNonMath(text){
  const t = (text||"").toLowerCase();
  const offTopic = /(Ø³ÙŠØ§Ø³Ø©|Ø¯ÙŠÙ†|Ø²ÙˆØ§Ø¬|Ø¹Ù„Ø§Ù‚Ø©|Ø­Ø¨|ÙƒØ±Ø©|Ù…Ø¨Ø§Ø±Ø§Ø©|ÙÙŠÙ„Ù…|Ù…Ø³Ù„Ø³Ù„|Ø£ØºÙ†ÙŠØ©|Ø·Ø¨Ø®|ÙˆØµÙØ©|Ø³ÙØ±|ÙˆØ¸ÙŠÙØ©|Ø±Ø§ØªØ¨|bitcoin|football|movie|music|relationship|politics|religion|recipe|travel|iphone|canon|Ø·Ø§Ø¨Ø¹Ø©|ÙˆØ§ØªØ³Ø§Ø¨|Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…|ØªÙŠÙƒ ØªÙˆÙƒ|Ø³Ù†Ø§Ø¨)/i;
  return offTopic.test(t) && !hasMathSignals(text);
}

/* ===== Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ===== */
function addMsg(role, text, opts={}){
  const row = document.createElement("div");
  row.className = "row " + (role === "me" ? "me" : "bot");

  const avatar = document.createElement("div");
  avatar.className = "avatar " + (role === "me" ? "me":"bot");
  avatar.textContent = role === "me" ? (lang==="ar" ? "Ø£" : "Me") : "âˆ‘";

  const wrap = document.createElement("div");
  wrap.className = "bubbleWrap";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta";

  const leftMeta = document.createElement("div");
  leftMeta.className = "leftMeta";
  leftMeta.innerHTML = `<span>${role === "me" ? (lang==="ar"?"Ø£Ù†Øª":"You") : (lang==="ar"?"Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡":"Ms. Asmaa")}</span> â€¢ <span>${nowTime()}</span>`;

  const rightMeta = document.createElement("div");
  rightMeta.className = "rightMeta";

  if(role === "bot"){
    const copyBtn = document.createElement("button");
    copyBtn.type = "button";
    copyBtn.className = "miniBtn";
    copyBtn.textContent = (lang==="ar" ? "Ù†Ø³Ø®" : "Copy");
    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(text);
        showToast(I18N[lang].copied);
      }catch{
        showToast(lang==="ar" ? "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø®" : "Copy failed");
      }
    });
    rightMeta.appendChild(copyBtn);
  }

  meta.appendChild(leftMeta);
  meta.appendChild(rightMeta);

  wrap.appendChild(bubble);
  wrap.appendChild(meta);

  if(role === "me"){
    row.appendChild(wrap);
    row.appendChild(avatar);
  }else{
    row.appendChild(avatar);
    row.appendChild(wrap);
  }

  chat.appendChild(row);

  if (window.MathJax && window.MathJax.typesetPromise) {
    window.MathJax.typesetPromise([bubble]).catch(()=>{});
  }

  const nearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 220;
  if (nearBottom || opts.forceScroll) scrollToBottom();

  saveChat();
}

/* typing */
let typingRow = null;
function showTyping(){
  if(typingRow) return;
  typingRow = document.createElement("div");
  typingRow.className = "row bot";

  const avatar = document.createElement("div");
  avatar.className = "avatar bot";
  avatar.textContent = "âˆ‘";

  const bubble = document.createElement("div");
  bubble.className = "typingBubble";
  bubble.innerHTML = `
    <div class="typingLine">
      <span>${I18N[lang].preparing}</span>
      <span class="dots"><span></span><span></span><span></span></span>
    </div>
  `;

  const wrap = document.createElement("div");
  wrap.className = "bubbleWrap";
  wrap.appendChild(bubble);

  typingRow.appendChild(avatar);
  typingRow.appendChild(wrap);

  chat.appendChild(typingRow);
  scrollToBottom();
}
function hideTyping(){
  if(!typingRow) return;
  typingRow.remove();
  typingRow = null;
}

function setBusy(b){
  sendBtn.disabled = b;
  input.disabled = b;
  statusText.textContent = b ? I18N[lang].busy : "";
}

function autoResize(){
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 140) + "px";
}
input.addEventListener("input", autoResize);
autoResize();

/* prefs */
function getPrefs(){ return { lang, level: levelSel.value, mode: modeSel.value }; }
function applyChips(){
  const level = levelSel.value;
  const mode = modeSel.value;
  lvlChip.textContent = (LEVEL_LABELS[level] ? LEVEL_LABELS[level][lang] : "");
  modeChip.textContent = (MODE_LABELS[mode] ? MODE_LABELS[mode][lang] : "");
  pillStatus.textContent = `${lvlChip.textContent} â€¢ ${modeChip.textContent}`;
}
function savePrefs(){
  try{ localStorage.setItem(PREF_KEY, JSON.stringify(getPrefs())); }catch{}
}
function loadPrefs(){
  try{
    const p = JSON.parse(localStorage.getItem(PREF_KEY) || "null");
    if(!p) return;
    if(p.lang) lang = p.lang;
    if(p.level) levelSel.value = p.level;
    if(p.mode) modeSel.value = p.mode;
  }catch{}
}
levelSel.addEventListener("change", ()=>{ applyChips(); savePrefs(); });
modeSel.addEventListener("change", ()=>{ applyChips(); savePrefs(); });

function renderPills(){
  const wrap = document.getElementById("pills");
  wrap.innerHTML = "";
  (PILL_EXAMPLES[lang] || []).forEach(ex=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "pill";
    b.textContent = ex;
    b.dataset.ex = ex;
    wrap.appendChild(b);
  });
  document.getElementById("pillHint").textContent = I18N[lang].pillHint;
}
document.getElementById("pills").addEventListener("click", (e)=>{
  const pill = e.target.closest(".pill");
  if(!pill) return;
  input.value = pill.dataset.ex || "";
  input.focus();
  autoResize();
});

function applyLang(next){
  lang = next;
  const t = I18N[lang];

  document.documentElement.lang = lang === "ar" ? "ar" : "en";
  document.documentElement.dir  = lang === "ar" ? "rtl" : "ltr";
  document.body.classList.toggle("ltr", lang === "en");

  document.getElementById("sideTitle").textContent = t.sideTitle;
  document.getElementById("sideSub").textContent = t.sideSub;
  document.getElementById("howTitle").textContent = t.howTitle;
  document.getElementById("howText").innerHTML = t.howText.replaceAll("\n","<br>");
  document.getElementById("langTitle").textContent = t.langTitle;

  document.getElementById("levelTitle").textContent = t.levelTitle;
  document.getElementById("lvlLabel").textContent = t.lvlLabel;
  document.getElementById("modeLabel").textContent = t.modeLabel;
  document.getElementById("levelHint").textContent = t.levelHint;

  mainTitle.textContent = t.mainTitle;
  mainSub.textContent   = t.mainSub;

  clearBtn.textContent = t.clear;
  sendBtn.textContent = t.send;
  input.placeholder = t.placeholder;

  btnAr.classList.toggle("active", lang==="ar");
  btnEn.classList.toggle("active", lang==="en");

  renderPills();
  applyChips();
  savePrefs();
}

btnAr.addEventListener("click", ()=>applyLang("ar"));
btnEn.addEventListener("click", ()=>applyLang("en"));

clearBtn.addEventListener("click", ()=>{
  chat.innerHTML = "";
  localStorage.removeItem(STORAGE_KEY);
  addMsg("bot", I18N[lang].cleared, {forceScroll:true});
});

/* =========================
âœ… Prefix Ù…ÙØµÙ„Ù‘Ø­:
- Ù„Ø§ ÙŠÙ‚ÙˆÙ„ "Ù…ØªØ®ØµØµ ÙÙ‚Ø·" Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ø«Ù„: Ù…Ø¹Ø§Ø¯Ù„Ø© ØªØ±Ø¨ÙŠØ¹ÙŠØ©/ØªÙØ§Ø¶Ù„ÙŠØ©/ODE/PDE
- Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ø¶Ø­ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª
========================= */
function buildPrefix(){
  const onlyMsg = I18N[lang].onlyMath;

  if(lang === "en"){
    return `You are Ms. Asmaa, a polite mathematics tutor.
CRITICAL:
- Differential equations, ODE, PDE, calculus, quadratic equations, algebra, geometry, statistics are ALL mathematics.
- DO NOT reply with the refusal message for any of these topics.
- Only refuse if the message is clearly non-math (like politics, relationships, movies, etc.).
Rules:
- Reply in ENGLISH only.
- Use standard readable math symbols: âˆš, Â², Â³, Ã—, Ã·, =, â‰¤, â‰¥.
- No LaTeX. No code blocks.
- If unclear: ask ONE short clarifying question, then solve with best assumption.
If (and only if) the message is clearly not math, reply with this exact text ONLY:
"${onlyMsg}"
`;
  }

  return `Ø£Ù†ØªÙ Ø§Ù„Ø£Ø³ØªØ§Ø°Ø© Ø£Ø³Ù…Ø§Ø¡ØŒ Ù…Ø¹Ù„Ù…Ø© Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù„Ø¨Ù‚ ÙˆÙˆØ§Ø¶Ø­.
Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§:
- Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªÙØ§Ø¶Ù„ÙŠØ©ØŒ ODEØŒ PDEØŒ Ø§Ù„ØªÙØ§Ø¶Ù„ ÙˆØ§Ù„ØªÙƒØ§Ù…Ù„ØŒ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„ØªØ±Ø¨ÙŠØ¹ÙŠØ©ØŒ Ø§Ù„Ø¬Ø¨Ø±ØŒ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©ØŒ Ø§Ù„Ø¥Ø­ØµØ§Ø¡ = ÙƒÙ„Ù‡Ø§ Ø±ÙŠØ§Ø¶ÙŠØ§Øª.
- Ù„Ø§ ØªÙƒØªØ¨ÙŠ Ø±Ø³Ø§Ù„Ø© "Ø£Ù†Ø§ Ù…Ø®ØªØµØ© Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙÙ‚Ø·" Ù„Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª.
- Ø§Ø±ÙØ¶ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø© Ø£Ù†Ù‡Ø§ Ù„ÙŠØ³Øª Ø±ÙŠØ§Ø¶ÙŠØ§Øª (Ø³ÙŠØ§Ø³Ø©ØŒ Ø¹Ù„Ø§Ù‚Ø§ØªØŒ Ø£ÙÙ„Ø§Ù…...).
Ù‚ÙˆØ§Ø¹Ø¯:
- Ø£Ø¬ÙŠØ¨ÙŠ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·.
- Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø±Ù…ÙˆØ²Ù‹Ø§ Ù…ÙÙ‡ÙˆÙ…Ø©: âˆš ØŒ Â² ØŒ Â³ ØŒ Ã— ØŒ Ã· ØŒ = ØŒ â‰¤ ØŒ â‰¥.
- Ø¨Ø¯ÙˆÙ† LaTeX ÙˆØ¨Ø¯ÙˆÙ† ÙƒØªÙ„ ÙƒÙˆØ¯.
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± ÙˆØ§Ø¶Ø­: Ø§Ø³Ø£Ù„ÙŠ Ø³Ø¤Ø§Ù„Ù‹Ø§ ØªÙˆØ¶ÙŠØ­ÙŠÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø«Ù… Ø­Ù„ÙŠ Ø¨Ø£ÙØ¶Ù„ Ø§ÙØªØ±Ø§Ø¶.
Ø¥Ø°Ø§ (ÙˆÙÙ‚Ø· Ø¥Ø°Ø§) ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙŠØ³Øª Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ØŒ Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙ‚Ø· Ø¯ÙˆÙ† Ø£ÙŠ Ø¥Ø¶Ø§ÙØ©:
"${onlyMsg}"
`;
}

/* =========================
Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
========================= */
function saveChat(){
  try{
    const items = [];
    chat.querySelectorAll(".row").forEach(row=>{
      const role = row.classList.contains("me") ? "me" : "bot";
      const bubble = row.querySelector(".bubble");
      const text = bubble ? bubble.textContent : "";
      items.push({ role, text });
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }catch{}
}
function loadChat(){
  try{
    const items = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
    if(!items || !Array.isArray(items) || items.length===0) return false;
    chat.innerHTML = "";
    items.forEach(it=> addMsg(it.role, it.text, {forceScroll:false}));
    return true;
  }catch{
    return false;
  }
}
async function send(){
  const q = input.value.trim();
  if(!q) return;

  // âœ… Ø±ÙØ¶ Ø´Ø¯ÙŠØ¯ Ø§Ù„ØµØ±Ø§Ù…Ø© ÙÙ‚Ø· (Ù„Ùˆ ÙˆØ§Ø¶Ø­ ØºÙŠØ± Ø±ÙŠØ§Ø¶ÙŠØ§Øª)
  if(isClearlyNonMath(q)){
    addMsg("me", q, {forceScroll:true});
    input.value = "";
    autoResize();
    addMsg("bot", I18N[lang].onlyMath, {forceScroll:true});
    return;
  }

  const level = levelSel.value;
  const mode  = modeSel.value;

  addMsg("me", q, {forceScroll:true});
  input.value = "";
  autoResize();

  setBusy(true);
  await new Promise(r => setTimeout(r, 50));
  showTyping();

  try{
    const styleHint =
      (lang === "en")
        ? `Student level: ${LEVEL_LABELS[level]?.en || level}. Answer style: ${MODE_LABELS[mode]?.en || mode}.`
        : `Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø·Ø§Ù„Ø¨: ${LEVEL_LABELS[level]?.ar || level}. Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: ${MODE_LABELS[mode]?.ar || mode}.`;

    // âœ… Ù†Ø¶ÙŠÙ Ø³Ø·Ø± â€œØªØ£ÙƒÙŠØ¯ Ø±ÙŠØ§Ø¶ÙŠØ§ØªÙŠâ€ ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠÙÙ‡Ù… Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²
    const mathConfirm =
      (lang === "en")
        ? "This is a MATH question. Treat terms like 'quadratic', 'differential equation', ODE/PDE as math."
        : "Ù‡Ø°Ø§ Ø³Ø¤Ø§Ù„ Ø±ÙŠØ§Ø¶ÙŠØ§Øª. Ø§Ø¹ØªØ¨Ø± (Ù…Ø¹Ø§Ø¯Ù„Ø© ØªØ±Ø¨ÙŠØ¹ÙŠØ©/Ù…Ø¹Ø§Ø¯Ù„Ø© ØªÙØ§Ø¶Ù„ÙŠØ©/ODE/PDE) ÙƒÙ„Ù‡Ø§ Ø±ÙŠØ§Ø¶ÙŠØ§Øª.";

    const finalMessage = buildPrefix() + "\n" + mathConfirm + "\n" + styleHint + "\n\n" + q;

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        message: finalMessage,
        language: lang,
        level: level,
        mode: mode
      })
    });

    const raw = await res.text();
    let data;
    try{ data = JSON.parse(raw); } catch { data = { answer: raw }; }

    hideTyping();

    const ansRaw = (data.answer || "").toString().trim();
    let ans = prettifyMathText(ansRaw);

    // âœ… Ù„Ø§ Ù†ÙÙ„ØªØ± Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø¨Ù‚Ø³ÙˆØ© (Ø­ØªÙ‰ Ù„Ø§ Ù†ÙƒØ³Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙØ§Ø¶Ù„)
    // ÙÙ‚Ø· Ù„Ùˆ ÙˆØ§Ø¶Ø­ Ø¬Ø¯Ù‹Ø§ ØºÙŠØ± Ø±ÙŠØ§Ø¶ÙŠØ§Øª:
    if(isClearlyNonMath(ans)){
      ans = I18N[lang].onlyMath;
    }

    addMsg("bot", ans || I18N[lang].noAnswer, {forceScroll:true});

  }catch(e){
    hideTyping();
    addMsg("bot", lang==="ar" ? "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…." : "Connection failed.", {forceScroll:true});
  }finally{
    setBusy(false);
    scrollToBottom();
  }
}

sendBtn.addEventListener("click", send);
input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

function updateToTop(){
  const scrolled = chat.scrollTop > 280;
  toTopBtn.classList.toggle("show", scrolled);
}
chat.addEventListener("scroll", updateToTop, { passive:true });
toTopBtn.addEventListener("click", ()=>{ scrollToTopHard(); });
updateToTop();

/* init */
loadPrefs();
applyLang(lang);
applyChips();

const restored = loadChat();
if(!restored){
  addMsg("bot", I18N[lang].greeting, {forceScroll:true});
}else{
  showToast(I18N[lang].restored);
  scrollToBottom();
}
</script>

</body>
</html>
